# 三、PostgreSQL 安装方法

## 1. 数据库集簇的构成

数据库集簇是指 PostgreSQL 用于存储数据库文件的区域，是文件系统上的一个目录。要创建数据库集簇，需使用 initdb 命令。数据库集簇的位置可以自由设置。

通常，数据库集簇本身及其目录路径使用操作系统的环境变量 $PGDATA 表示。



下图展示的是 $PGDATA 目录下的一部分结构。

```
数据库集群
$PGDATA
├── base/            │ 存放各数据库的子目录
├── global/          │ 存放用户信息及共享数据
├── log/             │ 存放日志文件
├── postgresql.conf  │ 设置参数
├── pg_hba.conf      │ 设置客户端认证信息
└── postmaster.pid   │ 记录识别正在运行的进程信息
```



-   数据库集簇与 PostgreSQL 服务器（进程组或服务）是一一对应关系。
-   不能通过多个服务器分布式管理一个数据库集簇。
-   一个数据库集簇中可以包含多个数据库。



### (1) 数据库集簇的三个数据库

通过执行 initdb 命令创建的数据库集群中，同时会定义三个数据库：template0、template1 和 postgres。

其中的 template0 和 template1 是在新建数据库时用作复制源的模板数据库。模板数据库可以在创建数据库时作为选项指定。

这两个模板数据库的作用不同：

数据库集群创建时最初就被定义的数据库

| 数据库名  | 说明                   |
| --------- | ---------------------- |
| template0 | 模板数据库（不可更改） |
| template1 | 模板数据库（可更改）   |
| postgres  | 可像普通数据库一样使用 |



-   **template0**

    这是一个**不能被修改**的模板数据库，不能对其进行更改，也无法删除 template0 本身。

    通常，在用户创建数据库时，默认会以 template1 为复制源。但如果不希望继承 template1 中的变更内容，可以指定以 template0 为复制源。

-   **template1**

    与 template0 不同，template1 是**可以进行更改**的模板数据库，可以注册或更新对象（如表、索引等）。

    当用户创建数据库时，默认会以它为复制源。

    如果今后要创建多个数据库，并希望它们包含相同的对象，可以预先将这些对象注册到 template1。这样，在创建新数据库时，相关对象将被自动复制。

-   **postgres**

    与普通数据库相同，是一个可以正常使用的数据库。

    它也是默认的连接目标。



[日本PostgreSQLユーザ会 PostgreSQL 14.5文書「23.3. テンプレートデータベース」](https://www.postgresql.jp/document/14/html/manage-ag-templatedbs.html)



## 2. PostgreSQL 服务器的环境构建

PostgreSQL 服务器（进程组或服务）的环境构建，主要包括 **PostgreSQL 的安装**、**数据库集簇的创建**以及**服务器的启动**等步骤。



PostgreSQL 的安装方式有两种：一种是从源代码编译安装，另一种是使用二进制包（已经构建好的软件包）。

二进制包不仅由 PostgreSQL 官方开发社区提供，也可以由其他组织构建提供。

此外，PostgreSQL 允许在一台机器上**安装多个版本并同时运行**。



创建数据库集簇时，需要使用 initdb 命令。只能由**非 root**（操作系统的管理员用户）的一般用户来创建数据库集簇。

**执行 initdb 命令的用户将成为该 PostgreSQL 实例的管理员用户**，因此 PostgreSQL 服务器的管理员用户与操作系统的管理员用户是不同的。



### (1) initdb 命令

-   initdb 命令需要在创建数据库集簇的主机上，以非 root 的 OS 用户身份执行。

-   该用户将成为数据库集簇的管理者。

-   不能从网络远程执行。
-   可通过选项指定用户名、目录、编码、locale 等设置。



命令格式如下：

```
initdb [选项] [目录名]
```



#### 常用选项

| 选项                           | 说明                                                         |
| ------------------------------ | ------------------------------------------------------------ |
| -D 目录名<br>--pgdata=目录名   | 指定要创建数据库集群的目录<br>如果未指定，则使用环境变量 `$PGDATA` |
| -E 编码<br>--encoding=编码     | 指定编码<br>如果未指定，则从操作系统的 locale 自动设定       |
| --locale=地区设定              | 指定 locale<br>如果未指定，则使用操作系统的 locale<br>（`--locale=C` 表示禁用 locale） |
| --no-locale                    | 禁用 locale，等同于 `--locale=C`                             |
| -U 用户名<br>--username=用户名 | 指定要创建的数据库的超级用户<br>如果未指定，则使用执行命令的操作系统用户名作为超级用户 |
| -k<br>--data-checksums         | 启用数据库校验和机制（用于检测数据损坏）                     |
| -X 目录名<br>--waldir=目录名   | 指定用于存储 WAL（预写日志：记录对数据库更改的日志）的目录   |

-   -D 指定的目录必须是**不存在或为空**的目录。
-   locale 是指根据国家或地区的各种设定，主要用于设定使用的语言、日期和时间的表示方式、货币等内容。
-   --no-locale 或 --locale=C 用于禁用 locale（地区设置）。
-   若不指定 locale，则使用 OS 的 locale 设置。



#### 示例

```bash
$ su - postgres        ← 切换为 postgres 用户
パスワード：

$ initdb --encoding=UTF8 --locale=C /pgdata
数据库系统中所有文件的所有者是“postgres”用户。
用户必须不拥有服务器进程。
数据库集群已使用 locale 初始化。
默认的文本搜索配置已设置为 english。
设置目录 /pgdata 的权限 …… ok
正在创建子目录 …… ok
正在选择默认的 max_connections 设置 …… 100
正在选择默认的 shared_buffers 设置 …… 32MB
正在创建配置文件 …… ok
正在创建数据库 template1 的副本 …… ok

～中略～

警告：本地连接默认启用了“trust”认证。
可以通过编辑 pg_hba.conf 文件，或在下次执行 initdb 时使用 -A 选项，
更改认证方式。

成功完成。可以使用以下命令启动数据库服务器：
    postmaster -D /pgdata
或
    pg_ctl -D /pgdata -l logfile start
```



也可使用 pg_ctl initdb(init) 命令创建数据库集簇，与 initdb 命令作用相同。



### (2) 字符集（Encoding）

编码（字符集）是指将英文、日文等各种字符转换为字节序列的一种编码方式。

用于存储在数据库中的字符数据的编码称为**数据库编码（服务器编码）**，客户端所使用的编码则称为**客户端编码**。



#### 数据库编码（服务器编码）

数据库编码是在创建数据库集簇（即 PostgreSQL 中用于存放数据库文件的文件系统目录）时，通过 initdb 命令加上选项进行设置的。在这里设置的编码将成为数据库的默认编码值。

例：`initdb --encoding=EUC_JP`



此外，使用 createdb 命令创建数据库时，也可以为每个数据库分别设置不同的编码。



#### 客户端编码

客户端编码是在执行 initdb 命令时生成的 postgresql.conf 文件（用于设置 PostgreSQL 的各种控制参数）中的 client_encoding 参数中进行指定的。该设置将作为客户端的默认编码值。

例：`client_encoding = SJIS`



另外，在使用 psql（PostgreSQL 附带的交互式终端工具）或 SQL 命令连接服务器时，也可以为每次连接设置不同的编码。



#### 日文常用编码

日语的编码方式包括 SJIS、EUC-JP、UTF8 等。

其中，**只有 SJIS 无法用作数据库编码**。

在客户端编码中，这三种编码都可以使用。

| **编码** | **用于数据库编码** | **用于客户端编码** |
| -------- | ------------------ | ------------------ |
| SJIS     | ❌ 不可用           | ✅ 可用             |
| EUC-JP   | ✅ 可用             | ✅ 可用             |
| UTF8     | ✅ 可用             | ✅ 可用             |

在 PostgreSQL 中，即使数据库编码与客户端编码的设置不同，也可以自动进行转换。



### (3) Locale（地区设置）

Locale 是指字符的排序方式、字符类型、货币、数字、日期和时间的表示方法等，因国家或地区而异的各种设置。

Locale 可通过 initdb 命令或 createdb 命令指定。

不过，在 PostgreSQL 中处理日语数据时，由于可能导致处理速度变慢等原因，**建议事先禁用 Locale 设置**。

要禁用 Locale，可在执行 initdb 时使用选项进行指定：

**示例**：initdb --no-locale 或 initdb --locale=C



如果未禁用 Locale，且设置了与该 Locale 不兼容的数据库编码，则 PostgreSQL 可能会报错。

另外，也可以为数据库端和客户端**分别设置不同的 Locale**。

