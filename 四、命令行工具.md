# 四、命令行工具

## 1. 客户端交互工具

客户端的含义：The common feature of these applications is that they can be run on any host, independent of where the database server resides.

[PostgreSQL Client Applications](https://www.postgresql.org/docs/current/reference-client.html)



### (1) psql

psql 是 PostgreSQL 附带的交互式接口。 以交互方式输入命令以执行 SQL 语句和元命令。 也可以使用元命令执行 OS 命令。

您还可以从文件中读取输入。 可以简化脚本的编写并自动执行各种任务。

数据库**超级用户**和**普通用户**都可以使用 psql 连接到数据库。 您可以通过 IP 地址或主机名指定目标主机。



psql 命令的格式如下：

```bash
psql [连接选项] [选项] [数据库名称[用户名]]
```



#### 主要连接选项

此选项用于连接到正在运行的 PostgreSQL 服务器。 如果没有可选设置，则使用环境变量，但没有环境变量设置，则使用默认设置。

| 连接选项            | 说明                                                       | 环境变量     | 默认值             |
| ------------------- | ---------------------------------------------------------- | ------------ | ------------------ |
| `-U 用户名`         | 指定连接时的数据库用户名                                   | `PGUSER`     | OS 用户名          |
| `-h 主机名或IP地址` | 指定连接目标的主机名或 IP 地址。支持 TCP/IP 或 UNIX 域连接 | `PGHOST`     | 使用 UNIX 域连接   |
| `-d 数据库名`       | 指定连接目标的数据库名称                                   | `PGDATABASE` | 与数据库用户名相同 |
| `-p 端口号`         | 指定连接目标的端口号                                       | `PGPORT`     | 5432               |

如示例中所示，假定 psql 命令中出现的第一个非可选参数是数据库名称。

示例：“psql -U exam data1” 通过指定用户名 exam 和数据库名称 data1 进行连接。



#### psql 的主要选项

| 选项                             | 说明                                                         |
| -------------------------------- | ------------------------------------------------------------ |
| `-l` <br> `--list`               | 显示所有数据库的列表后退出 psql                              |
| `-c 命令` <br> `--command=命令`  | 执行指定的命令并显示结果后退出 psql                          |
| `-f 文件名` <br> `--file=文件名` | 将指定文件作为源读取并执行，显示结果后退出 psql              |
| `-s` <br> `--single-step`        | 每条命令执行前进行确认是否执行（单步模式）                   |
| `-1` <br> `--single-transaction` | 将多个命令作为一个事务执行，仅当与 `-c` 或 `-f` 选项组合时可使用 |

您还可以在加载指定文件时使用 shell 输出重定向 （<） 写入 “< 文件名”。



#### 示例

这是执行 -l 选项的一个示例。

```bash
$ psql -l

             数据库列表

  名称     | 所有者   | 编码  | 排序规则 | Ctype（字符类型） | 访问权限
-----------+----------+-------+-----------+--------------------+------------
 exam      | user1    | UTF8  | C         | C                  |
 examdb    | postgres | UTF8  | C         | C                  |
 examdb1   | user1    | UTF8  | C         | C                  |
 postgres  | postgres | UTF8  | C         | C                  |
 template0 | postgres | UTF8  | C         | C                  |
 template1 | postgres | UTF8  | C         | C                  |
(6 行)
```



#### SQL 命令

PostgreSQL 可以将 SQL 命令与 psql 一起使用。

长 SQL 命令可以分多行输入，SQL 命令以分号 “;” 结尾使用以下方法确定：

在下图中，`SELECT * FROM user;`我通过分隔可以在一句话中输入的地方来输入。



如果您以普通用户身份连接，则 psql 提示符将显示为 “database name=>”。 下图是一般用户 “user” 的示例。

```bash
$ psql -U user examdb
psql (9.0.23)
Type "help" for help.

examdb=> SELECT
examdb-> *
examdb-> FROM
examdb-> user;
examdb=> \q
```

如果位于句子中间，则提示中数据库名称后面的字符串将显示为 “-”而不是 “=”，例如，“->”。



如果您以超级用户身份连接，则 psql 提示符将显示为 “database name=#”。 下图是超级用户 “postgres” 的示例。

```bash
$ psql -U postgres examdb
psql (9.0.23)
Type "help" for help.

examdb=# \q
```



#### 元命令

PostgreSQL 可以将元命令与 psql 一起使用。 元命令是 psql 可以单独使用的命令，以 “\” 开头，以换行符结尾。 退出 psql 本身时，它是 “\q”。

SQL 命令可以在多行中输入，但元命令不能分隔为多行。



##### 主要元命令

| 命令             | 获取的信息说明               |
| ---------------- | ---------------------------- |
| `\l`             | 数据库列表                   |
| `\d`             | 表、视图、序列的列表         |
| `\dt`            | 表的列表                     |
| `\du`            | 用户的列表                   |
| `\z`（或 `\dp`） | 表、视图、序列的访问权限列表 |
| `\?`             | 元命令一览                   |
| `\h [SQL命令]`   | SQL 命令的帮助信息           |
| `\! [OS命令]`    | 执行操作系统命令的结果       |



##### 示例

这是执行元命令 “\h” 的示例。

```bash
postgres=# \h
Available help:
  ABORT                            CREATE USER
  ALTER AGGREGATE                  CREATE USER MAPPING
  ALTER COLLATION                  CREATE VIEW
  ALTER CONVERSION                 DEALLOCATE
  ALTER DATABASE                   DECLARE
  ALTER DEFAULT PRIVILEGES         DELETE
  ALTER DOMAIN                     DISCARD
```



[日本PostgreSQLユーザ会 PostgreSQL 14.5文書「psql」：オプション](https://www.postgresql.jp/document/14/html/app-psql.html#R1-APP-PSQL-3)



### (2) pg_config

pg_config命令用于查看当前安装的 PostgreSQL 版本的信息。 您可以检查 PostgreSQL 版本(VERSION)、安装配置选项(CONFIGURE)以及二进制文件(BINDIR)、库(LIBDIR)和头文件(INCLUDEDIR)的目录路径。



#### 示例

```bash
root@99768adce40b:/# pg_config
BINDIR = /usr/lib/postgresql/17/bin
DOCDIR = /usr/share/doc/postgresql-doc-17
HTMLDIR = /usr/share/doc/postgresql-doc-17
INCLUDEDIR = /usr/include/postgresql
PKGINCLUDEDIR = /usr/include/postgresql
INCLUDEDIR-SERVER = /usr/include/postgresql/17/server
LIBDIR = /usr/lib/aarch64-linux-gnu
PKGLIBDIR = /usr/lib/postgresql/17/lib
LOCALEDIR = /usr/share/locale
MANDIR = /usr/share/postgresql/17/man
SHAREDIR = /usr/share/postgresql/17
SYSCONFDIR = /etc/postgresql-common
PGXS = /usr/lib/postgresql/17/lib/pgxs/src/makefiles/pgxs.mk
CONFIGURE =  '--build=aarch64-linux-gnu' '--prefix=/usr' '--includedir=${prefix}/include' '--mandir=${prefix}/share/man' '--infodir=${prefix}/share/info' '--sysconfdir=/etc' '--localstatedir=/var' '--disable-option-checking' '--disable-silent-rules' '--libdir=${prefix}/lib/aarch64-linux-gnu' '--runstatedir=/run' '--disable-maintainer-mode' '--disable-dependency-tracking' '--with-tcl' '--with-perl' '--with-python' '--with-pam' '--with-openssl' '--with-libxml' '--with-libxslt' '--mandir=/usr/share/postgresql/17/man' '--docdir=/usr/share/doc/postgresql-doc-17' '--sysconfdir=/etc/postgresql-common' '--datarootdir=/usr/share/' '--datadir=/usr/share/postgresql/17' '--bindir=/usr/lib/postgresql/17/bin' '--libdir=/usr/lib/aarch64-linux-gnu/' '--libexecdir=/usr/lib/postgresql/' '--includedir=/usr/include/postgresql/' '--with-extra-version= (Debian 17.5-1.pgdg120+1)' '--enable-nls' '--enable-thread-safety' '--enable-debug' '--disable-rpath' '--with-uuid=e2fs' '--with-gnu-ld' '--with-gssapi' '--with-ldap' '--with-pgport=5432' '--with-system-tzdata=/usr/share/zoneinfo' 'AWK=mawk' 'MKDIR_P=/bin/mkdir -p' 'PROVE=/usr/bin/prove' 'PYTHON=/usr/bin/python3' 'TAR=/bin/tar' 'XSLTPROC=xsltproc --nonet' 'CFLAGS=-g -O2 -fstack-protector-strong -Wformat -Werror=format-security' 'LDFLAGS=-Wl,-z,relro -Wl,-z,now' '--enable-tap-tests' '--with-icu' '--with-llvm' 'LLVM_CONFIG=/usr/bin/llvm-config-19' 'CLANG=/usr/bin/clang-19' '--with-lz4' '--with-zstd' '--with-systemd' '--with-selinux' '--enable-dtrace' 'build_alias=aarch64-linux-gnu' 'CPPFLAGS=-Wdate-time -D_FORTIFY_SOURCE=2' 'CXXFLAGS=-g -O2 -fstack-protector-strong -Wformat -Werror=format-security'
CC = gcc
CPPFLAGS = -Wdate-time -D_FORTIFY_SOURCE=2 -D_GNU_SOURCE -I/usr/include/libxml2
CFLAGS = -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Werror=vla -Wendif-labels -Wmissing-format-attribute -Wimplicit-fallthrough=3 -Wcast-function-type -Wshadow=compatible-local -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -Wno-format-truncation -Wno-stringop-truncation -moutline-atomics -g -g -O2 -fstack-protector-strong -Wformat -Werror=format-security
CFLAGS_SL = -fPIC
LDFLAGS = -Wl,-z,relro -Wl,-z,now -L/usr/lib/llvm-19/lib -Wl,--as-needed
LDFLAGS_EX =
LDFLAGS_SL =
LIBS = -lpgcommon -lpgport -lselinux -lzstd -llz4 -lxslt -lxml2 -lpam -lssl -lcrypto -lgssapi_krb5 -lz -lreadline -lm
VERSION = PostgreSQL 17.5 (Debian 17.5-1.pgdg120+1)
```



### (3) pg_isready

pg_isready命令用于检查与数据库服务器的连接状态。 此命令充当客户端应用程序，允许您检查来自不同计算机的连接。 当您运行 pg_isready 时，结果将作为退出状态返回。 退出状态为 0 表示连接成功，非零状态表示连接失败。



#### 示例

```bash
$ pg_isready
/var/run/postgresql:5432 - accepting connections   <- 当服务器正在运行时
$ echo $?
0                                      <- 退出状态为 0

$ pg_ctl stop
waiting for server to shut down.... done
server stopped

$ pg_isready
/var/run/postgresql:5432 - no response         <- 当服务器已停止时
$ echo $?
2                                      <- 退出状态为非 0
```



### (4) createuser 命令

createuser 命令为 PostgreSQL 定义一个新的用户账户。 这相当于执行 SQL 命令 “CREATE ROLE/CREATE USER”。



createuser 命令的格式如下：

```bash
createuser [连接选项] [选项] [用户名]
```



#### 主要连接选项

它用于连接到正在运行的 PostgreSQL 服务器。 可以通过 TCP/IP 或 UNIX 域建立连接。



-U 用户名

指定连接的数据库用户名。



-h 主机名或 IP 地址

指定要连接的主机名或 IP 地址。



-p 端口名称

指定要连接的端口号。 默认值为 5432。



#### createuser 命令的主要选项

| 选项                        | 说明                             |
| --------------------------- | -------------------------------- |
| `-P` <br> `--pwprompt`      | 设置密码                         |
| `-s` <br> `--superuser`     | 将新用户创建为超级用户           |
| `-d` <br> `--createdb`      | 允许新用户创建数据库             |
| `-r` <br> `--createrole`    | 允许新用户创建其他用户（角色）   |
| `-l` <br> `--login`         | 允许登录（默认）                 |
| `-S` <br> `--no-superuser`  | 不将新用户设置为超级用户（默认） |
| `-D` <br> `--no-createdb`   | 禁止新用户创建数据库（默认）     |
| `-R` <br> `--no-createrole` | 禁止新用户创建其他用户（默认）   |
| `-L` <br> `--no-login`      | 禁止登录                         |



只有**超级用户和具有 CREATEROLE 权限** （创建用户的能力） 的用户才能使用此命令创建新的用户帐户。

**如果要创建新的超级用户，则必须以超级用户身份进行连接。**



createuser 命令可以在命令行上以交互方式进行配置。 创建新用户时，该用户在命令行中称为 “新角色”。 它与 “新用户” 是同一个意思。



#### 示例

使用连接选项 -U 以名为 postgres 的超级用户身份进行连接。

-P 选项设置密码，-S 选项将其设置为在创建时不是超级用户。

```bash
$ createuser -U postgres -P -S
请输入要添加的角色名：user
请输入新角色的密码：
请再输入一次密码：
是否赋予新角色创建数据库的权限？ (y/n) y
是否赋予新角色创建其他角色的权限？ (y/n) n
```

\* 如果未如上例所示在命令中指定要创建的用户名，则系统将以交互方式提示您执行（PostgreSQL 9.1 之前）。

在 9.2 及更高版本中，如果要交互式创建用户，则需要指定 “--interactive” 选项。

```bash
$ createuser -U postgres --interactive
请输入要添加的角色名：user1
是否将新角色设为超级用户？(y/n) n
是否赋予新角色创建数据库的权限？(y/n) n
是否赋予新角色创建其他角色的权限？(y/n) n
```



[日本PostgreSQLユーザ会 PostgreSQL 14.5文書「createuser」](https://www.postgresql.jp/document/14/html/app-createuser.html)



### (5) dropuser 命令

dropuser 命令用于删除 PostgreSQL 用户帐户。 这相当于执行 SQL 命令 “DROP ROLE/DROP USER”。

\* PostgreSQL 具有角色的概念。 角色是一组多个用户，但单个数据库用户也被视为一个角色。



dropuser 命令的格式如下：

```bash
dropuser [连接选项] [选项] [用户名]
```



#### 主要连接选项

它用于连接到正在运行的 PostgreSQL 服务器。 可以通过 TCP/IP 或 UNIX 域建立连接。



-U 用户名

指定连接的数据库用户名。



-h 主机名或 IP 地址

指定要连接的主机名或 IP 地址。



-p 端口名称

指定要连接的端口号。 默认值为 5432。



#### dropuser 命令的主要选项

-i 或 --interactive

删除前提示确认。 此外，如果未在命令中指定要删除的用户名的名称，系统将以交互方式提示您。



[示例]

连接选项 -U 指定超级用户的 postgres。

--interactive 选项用于在删除之前提示确认。

```bash
$ dropuser -U postgres --interactive
请输入要删除的角色名：user
角色 "user" 将被永久删除
是否执行？(y/n) y
```



此命令只能由**超级用户和具有 CREATEROLE 权限（创建用户的能力）**的用户使用，以删除现有的 PostgreSQL 用户。

此外，如果要删除超级用户，则必须以**超级用户身份**进行连接。

请注意，您无法删除拥有数据库对象（如数据库或表）的用户。

```bash
$ dropuser -U postgres user
dropuser: 删除角色 "user" 失败：ERROR:  role "user"
cannot be dropped because some objects depend on it  
DETAIL:  owner of table table1
```



[日本PostgreSQLユーザ会 PostgreSQL 14.5文書「dropuser」](https://www.postgresql.jp/document/14/html/app-dropuser.html)



### (6) createdb 命令

createdb 命令创建一个新数据库。 相当于执行 SQL 命令 “CREATE DATABASE”。



createdb 命令的格式如下：

```bash
createdb [连接选项] [选项] [数据库名称]
```



#### 主要连接选项

它用于连接到正在运行的 PostgreSQL 服务器。 可以通过 TCP/IP 或 UNIX 域建立连接。



-U 用户名

指定连接的数据库用户名。



-h 主机名或 IP 地址

指定要连接的主机名或 IP 地址。



-p 端口名称

指定要连接的端口号。 默认值为 5432。



#### createdb 命令的主要选项

| 选项                                 | 说明                                     |
| ------------------------------------ | ---------------------------------------- |
| -E 编码<br>--encoding=编码           | 指定在数据库内使用的编码                 |
| -O 用户名<br>--owner=用户名          | 指定新建数据库的所有者用户               |
| -l 区域设定名<br>--locale=区域设定名 | 指定数据库中使用的区域设定               |
| -T 模板名<br>--template=模板名       | 指定模板数据库（template0 或 template1） |



createdb 命令只能由超级用户和具有 CREATEDB 权限（创建数据库的能力）的用户执行。

执行此命令的用户将成为新数据库的所有者。

如果执行用户是<u>超级用户</u>，则可以使用 -O 选项<u>将另一个用户指定为所有者</u>。 如果执行用户没有超级用户权限，则可以将自己指定为所有者，但**不能指定任何其他用户**。

如果您是数据库的所有者，则可以删除或重命名数据库。 您无需是超级用户或具有 CREATEDB 权限的用户。



创建新数据库时，可以使用 -T 选项指定将用作数据库起点的模板。 创建数据库集群时，这些模板是 template0 和 template1。 **如果未指定任何内容，则为 template1**。 **encoding 和 locale 继承了模板的设置**。

如果指定了 template1，则**无法更改** template1 中设置的编码和区域设置。

如果要**独立于模板设置编码和区域设置，请指定 template0 并使用 -E 和 -l 选项**更改它们。



#### 示例

在下图的示例中，我们创建了一个名为 testdb 的新数据库。

```bash
$ createdb -U postgres -E EUC_JP -T template0 testdb
$ psql -l
                                       数据库一览
    名称     | 所有者   | 编码        | 排序规则 | Ctype（转换算子） | 访问权限
-------------+----------+-------------+----------+-------------------+-----------
 exam        | user1    | UTF8        | C        | C                 |
 examdb      | postgres | UTF8        | C        | C                 |
 examdb1     | user1    | UTF8        | C        | C                 |
 postgres    | postgres | UTF8        | C        | C                 |
 template0   | postgres | UTF8        | C        | C                 |
 template1   | postgres | UTF8        | C        | C                 |
 testdb      | postgres | EUC_JP      | C        | C                 |
(7 行)
```



**对于 template0 以外的模板**，如果尝试使用 -E、-l 选项更改 createdb 命令，则 createdb 命令将失败。

[示例]

下图显示了使用以 UTF8 配置的 template1 作为模板创建具有不同编码 （EUC_JP） 的新数据库 testdb 的失败尝试。

```bash
$ createdb -U postgres -E EUC_JP -T template1 testdb
createdb：数据库的生成失败了
ERROR: new encoding (EUC_JP) is incompatible with the encoding of the template database (UTF8)
HINT: Use the same encoding as in the template database, or use template0 as template.
```



补充

Q；为什么 template0 是无法更改的模版，但却可以更改编码和locale？

A；其实 template0 本身也不能“更改”编码或 locale。它的“特别之处”在于：它是一个“干净的、不变的、不会被修改的”模板数据库，因此在用它作为*创建新数据库*的来源时，PostgreSQL 允许你指定新的编码和 locale —— 而不是继承 template0 的设定。



Q；那为什么可以用 template0 而不能用 template1？

A；

| 比较项                       | template0                                  | template1                        |
| ---------------------------- | ------------------------------------------ | -------------------------------- |
| 是否可更改内容               | ❌ 不可更改，系统只读                       | ✅ 可更改，用户可添加对象         |
| 是否保持干净状态             | ✅ 永远干净、无用户对象、无副作用           | ❌ 可能包含用户自定义对象或设置   |
| 是否允许修改 encoding/locale | ✅ 可以在新数据库创建时指定新的设定         | ❌ 必须继承 template1 的设定      |
| 原因                         | 没有风险地“干净复制”，安全创建新设定数据库 | 为了防止已有对象的行为与设定冲突 |



[日本PostgreSQLユーザ会 PostgreSQL 14.5文書「createdb」](https://www.postgresql.jp/document/14/html/app-createdb.html)



### (7) dropdb 命令

dropdb 命令用于删除已在 PostgreSQL 中创建的数据库。 相当于执行 SQL 命令 “DROP DATABASE” （删除数据库）。



dropdb 命令的格式如下：

```bash
dropdb [连接选项] [选项] [数据库名称]
```



#### 主要连接选项

它用于连接到正在运行的 PostgreSQL 服务器。 可以通过 TCP/IP 或 UNIX 域建立连接。



-U 用户名

指定连接的数据库用户名。



-h 主机名或 IP 地址

指定要连接的主机名或 IP 地址。



-p 端口名称

指定要连接的端口号。 默认值为 5432。



#### dropdb 命令的主要选项

-i 或 --interactive

删除前会提示确认信息。



#### 示例

使用连接选项 -U，指定超级用户 postgres 并删除数据库 testdb。

-i 选项用于在删除之前提示确认信息。

$ dropdb -U postgres -i testdb
数据库“testdb”将被永久删除。
是否执行？(y/n)y

```bash
$ psql -l
             数据库一览
 名前     | 所有者   | 编码    | 排序规则 | Ctype(变换算法) | 访问权限
----------+----------+---------+----------+----------------+----------
 exam     | user1    | UTF8    | C        | C              |
 examdb   | postgres | UTF8    | C        | C              |
 examdb1  | user1    | UTF8    | C        | C              |
 postgres | postgres | UTF8    | C        | C              |
 template0| postgres | UTF8    | C        | C              |
 template1| postgres | UTF8    | C        | C              |
(共6行)
```



只有**超级用户和数据库的所有者**才能删除 PostgreSQL 数据库。



[日本PostgreSQLユーザ会 PostgreSQL 14.5文書「dropdb」](https://www.postgresql.jp/document/14/html/app-dropdb.html)





## 2. 服务器端工具

服务器端的含义：These commands can only be run usefully on the host where the database server resides.

[PostgreSQL Server Applications](https://www.postgresql.org/docs/current/reference-server.html)



### (1) pg_ctl 命令

pg_ctl 命令**启动和关闭** PostgreSQL 服务器、**初始化数据库集群**等。 它还用作管理工具，用于在启动期间显示状态。

pg_ctl命令由运行 PostgreSQL 的主机上的 PostgreSQL 管理员用户执行。 它不能由 root 用户或任何其他用户运行。 此外，pg_ctl 命令不能通过网络从其他主机运行。



pg_ctl命令的格式如下：

```bash
pg_ctl 子命令 [options]
```



pg_ctl 命令具有多种子命令。 使用这些子命令执行 PostgreSQL 服务器作。 此外，每个子命令都有自己的选项。



**pg_ctl 命令的子命令**

| 子命令        | 说明                                       |
| ------------- | ------------------------------------------ |
| initdb (init) | 创建新的数据库集群                         |
| start         | 在后台启动 PostgreSQL 服务器               |
| stop          | 关闭（停止）数据库服务器                   |
| restart       | 重启（执行 stop 后再执行 start）           |
| reload        | 重新加载配置文件                           |
| status        | 确认 PostgreSQL 服务器是否正在运行         |
| kill          | 向进程发送信号（通常用于终止特定后台进程） |

每个子命令的详细说明如下。



#### pg_ctl initdb 或 pg_ctl init

initdb 或 init 是创建新数据库集群的子命令。 这与执行在 “如何安装” 字段中学习的 initdb 命令的结果相同。



##### 主要选项

| 选项            | 说明                                                         |
| --------------- | ------------------------------------------------------------ |
| -D 目录名       | 指定数据库集群的存储目录                                     |
| --pgdata=目录名 | 与 `-D` 相同。若未指定，则使用环境变量 `$PGDATA` 的值作为默认目录 |



#### pg_ctl start

start 是一个子命令，它在**后台启动**新的 PostgreSQL 服务器。



##### 主要选项

| 选项                                      | 说明                                                         |
| ----------------------------------------- | ------------------------------------------------------------ |
| -D 数据库集群名 <br>--pgdata=数据库集群名 | 指定目标数据库集群 <br>与 `-D` 相同。若未指定，则使用环境变量 `$PGDATA` |
| -W                                        | 不等待启动完成，立即将控制权返回命令行（默认会等待最多60秒并显示启动完成消息） |
| -t 最大等待时间                           | 指定等待启动处理完成的最大时间，默认是60秒                   |



#### pg_ctl stop

stop 是一个子命令，用于关闭正在运行的 PostgreSQL 服务器。

执行命令后，**将立即禁止来自新客户端的连接**。



##### 主要选项

| 选项                                      | 说明                                                         |
| ----------------------------------------- | ------------------------------------------------------------ |
| -D 数据库集群名 <br>--pgdata=数据库集群名 | 指定目标数据库集群 <br>若未指定，则使用环境变量 `$PGDATA`    |
| -m 停止模式                               | 指定三种不同的关闭（shutdown）方式之一                       |
| -W                                        | 不等待停止完成，立即将控制权返回命令行（默认最多等待60秒并显示停止完成消息） |
| -t 最大等待时间                           | 指定等待关闭完成的最长时间，未指定时为60秒                   |



使用 -m 选项有三种类型的关闭模式。

##### -m 可选关机模式

| 关机模式 (Shutdown Mode)    | 说明                                                         |
| --------------------------- | ------------------------------------------------------------ |
| f 或 fast <br>高速关闭      | 中断正在执行的处理，强制断开所有客户端连接后立即关闭（默认）。<br>正在执行的事务会被回滚，数据库状态恢复到事务开始前。 |
| i 或 immediate <br>即时关闭 | 强制终止正在执行的处理，强制断开所有客户端连接后立即关闭。 <br>下次启动时会执行恢复处理。 |
| s 或 smart <br>智能关闭     | 等所有客户端连接断开后再关闭。 <br>正在执行的处理会在关闭前正常完成。 |

\* 在 9.5 版本之前，SMART 是默认模式。



##### fast 和 immediate 的区别

fast 在执行关机之前会将正在执行的事务回滚到其以前的状态，然后将其关闭，而 immediate 不会进行一系列的中断处理，直接停止服务器进程本身。

immediate 与服务器的进程崩溃的结果是相同的，因此服务器在下次启动时需要进行恢复，给服务器造成负担。 如果没有特殊理由使用 immediate，最好使用 fast 关闭。



[示例]

```bash
$ pg_ctl stop -m f  
正在等待服务器停止处理完成……完成  
服务器已停止
```



#### pg_ctl restart

restart 是重新启动 PostgreSQL 服务器的子命令。 （这与运行 STOP 然后运行 START 相同。 )



##### 主要选项

| 选项                                         | 说明                                                         |
| -------------------------------------------- | ------------------------------------------------------------ |
| -D 数据库集群名称<br>--pgdata=数据库集群名称 | 指定目标数据库集群目录。<br>未指定时使用环境变量 `$PGDATA`   |
| -m 停止模式                                  | 指定三种不同的关闭（停止）方式之一                           |
| -W                                           | 不等待启动完成即返回命令提示符（默认最多等待 60 秒，并显示启动完成消息） |
| -t 最大等待时间                              | 指定启动或关闭处理完成前的等待时间，未指定时默认 60 秒       |

如果在最长等待时间内未完成关闭，则 pg_ctl 重新启动将被视为失败，但**仍会执行 PostgreSQL 服务器关闭**。



-m 选项与 pg_ctl stop 命令相同。



##### 示例

```bash
$ pg_ctl restart -m f
正在等待服务器停止处理完成……完成  
服务器已停止  
正在等待服务器启动完成……完成  
服务器启动完成
```



#### pg_ctl reload

reload 是一个子命令，用于重新读取 PostgreSQL 服务器上的配置文件，例如“postgresql.conf”和“pg_hba.conf”（用于配置客户端身份验证的文件）。 （某些参数无法反映。 )



##### 主要选项

| 选项                  | 说明                               |
| --------------------- | ---------------------------------- |
| -D 数据库集群名       | 指定目标数据库集群                 |
| --pgdata=数据库集群名 | 若未指定，则使用环境变量 `$PGDATA` |



#### pg_ctl status

status 是一个子命令，用于检查 PostgreSQL 服务器是否已启动并正在运行。



##### 主要选项

| 选项                  | 说明                               |
| --------------------- | ---------------------------------- |
| -D 数据库集群名       | 指定目标数据库集群                 |
| --pgdata=数据库集群名 | 若未指定，则使用环境变量 `$PGDATA` |



##### 示例

执行子命令 status 以检查它是否正在运行。

```bash
$ pg_ctl status
pg_ctl: 服务器正在运行中 (PID: 878)
/usr/pgsql-9.0/bin/postgres
```



#### pg_ctl kill

pg_ctl kill 命令直接向 PostgreSQL 服务器上的进程发送信号，停止该进程并重新加载配置文件。



pg_ctl kill 命令的格式如下：

```bash
pg_ctl kill [信号名称] [进程 ID]
```



##### 主要信号

TERM（与pg_ctl stop -m smart 相同）

等到所有客户端连接都断开连接后，再关闭。



INT （与 pg_ctl stop -m fast 相同）

快速关闭并返回到开始处理正在运行的事务的状态 （回滚）。



QUIT（与 pg_ctl stop -m immediate 相同）

停止服务器进程本身，而不执行任何最终处理，例如将正在运行的事务回滚到其以前的状态。 这与服务器的进程崩溃并停止相同，因此服务器在下次启动时不堪重负，无法执行恢复过程。



HUP（与 pg_ctl reload 相同）

重新加载配置文件。



##### 示例

使用 pg_ctl status 命令检查进程 ID，如下图所示。

```bash
$ pg_ctl status
pg_ctl: 服务器正在运行中 (PID: 878)
/usr/pgsql-9.0/bin/postgres
$ pg_ctl kill INT 878
```



[日本PostgreSQLユーザ会 PostgreSQL 14.5文書「pg-ctl」：説明](https://www.postgresql.jp/document/14/html/app-pg-ctl.html#APP-PG-CTL-DESCRIPTION)

[OSSでLinuxサーバ構築「PostgreSQLの起動・停止」](https://ossfan.net/setup/postgresql-11.html)



### (2) pg_controldata

pg_controldata命令检索**由 initdb 初始化的整个数据库集群的控制信息**。 



显示 WAL（预写日志记录：记录数据库更改的日志）、检查点信息、目录（系统目录）版本信息等。



**检查点**(Checkpoint)是将数据更改传播到磁盘的过程。

当数据更改时，PostgreSQL 不会直接在磁盘上更新数据，而是将读取的数据更新到称为共享缓冲区的区域，该区域是共享内存的一部分。 之后，共享缓冲区的内容被收集并通过称为 checkpoint 的进程写入磁盘上的数据文件。 这可以提高更新期间的性能。



**系统目录**(Catalog)是指特定于 PostgreSQL 的表，用于存储有关数据库的内部信息。



检索的信息基于每个数据库集群。

该命令必须由执行 initdb 的数据库集群的 admin 用户执行。

格式如下：

```bash
pg_controldata [-D] [directory_name]
```



#### 示例

```bash
root@99768adce40b:/# echo $PGDATA
/var/lib/postgresql/data

root@99768adce40b:/# pg_controldata -D /var/lib/postgresql/data/
pg_control version number:            1700
Catalog version number:               202406281
Database system identifier:           7513184948135981095
Database cluster state:               in production
pg_control last modified:             Sat 12 Jul 2025 12:13:35 PM UTC
Latest checkpoint location:           0/74B5D30
Latest checkpoint's REDO location:    0/74B5CD8
Latest checkpoint's REDO WAL file:    000000010000000000000007
Latest checkpoint's TimeLineID:       1
Latest checkpoint's PrevTimeLineID:   1
Latest checkpoint's full_page_writes: on
Latest checkpoint's NextXID:          0:1924
Latest checkpoint's NextOID:          28331
Latest checkpoint's NextMultiXactId:  1
Latest checkpoint's NextMultiOffset:  0
Latest checkpoint's oldestXID:        731
Latest checkpoint's oldestXID's DB:   1
Latest checkpoint's oldestActiveXID:  1924
Latest checkpoint's oldestMultiXid:   1
Latest checkpoint's oldestMulti's DB: 1
Latest checkpoint's oldestCommitTsXid:0
Latest checkpoint's newestCommitTsXid:0
Time of latest checkpoint:            Sat 12 Jul 2025 12:13:35 PM UTC
Fake LSN counter for unlogged rels:   0/3E8
Minimum recovery ending location:     0/0
Min recovery ending loc's timeline:   0
Backup start location:                0/0
Backup end location:                  0/0
End-of-backup record required:        no
wal_level setting:                    replica
wal_log_hints setting:                off
max_connections setting:              100
max_worker_processes setting:         8
max_wal_senders setting:              10
max_prepared_xacts setting:           0
max_locks_per_xact setting:           64
track_commit_timestamp setting:       off
Maximum data alignment:               8
Database block size:                  8192
Blocks per segment of large relation: 131072
WAL block size:                       8192
Bytes per WAL segment:                16777216
Maximum length of identifiers:        64
Maximum columns in an index:          32
Maximum size of a TOAST chunk:        1996
Size of a large-object chunk:         2048
Date/time type storage:               64-bit integers
Float8 argument passing:              by value
Data page checksum version:           0
Mock authentication nonce:            f61123dd82fbf9b00e76309138d93dfa44b98eca2a945d395a2e415cff0e1e1a
```



### (3) pg_resetwal

pg_resetwal command 是初始化 WAL 和一些控制信息的命令。 如果 PostgreSQL 服务器由于这些文件损坏而无法启动，则可以通过执行该命令将服务器恢复到可启动的状态。

为了访问数据库集群的目录，必须以 PostgreSQL 管理员用户身份运行该目录。

格式如下：

```bash
pg_resetwal [可选] 目录名称
```



#### pg_resetwal 命令的主要选项

| 选项                  | 说明                                     |
| --------------------- | ---------------------------------------- |
| `-D` <br> `--pgdata`  | 指定目标数据库集群的数据目录             |
| `-n` <br> `--dry-run` | 实际不执行更改处理，仅输出将要更改的内容 |
| `-f` <br> `--force`   | 即使无法读取控制信息，也强制执行操作     |



pg_resetwal命令不使用环境变量 PGDATA，因此您必须在运行时在命令行上显式地指定它。



#### 示例

```bash
$ pg_ctl -D data01 start
waiting for server to start....2023-05-30 17:05:51.493 JST [2066] LOG:  redirecting log output
2023-05-30 17:05:51.493 JST [2066] HINT:  Future log output will appear in directory "log".
stopped waiting
pg_ctl: could not start server                    <- 启动服务器失败
Examine the log output.
$ cat data01/log/postgresql-Tue.log

～中略～

2023-05-30 17:05:51.493 JST [2066] LOG:  starting PostgreSQL 14.7 on aarch64-unknown-linux-gnu, 
compiled by gcc (GCC) 11.3.1 20220421 (Red Hat 11.3.1-2), 64-bit
2023-05-30 17:05:51.494 JST [2066] LOG:  listening on IPv6 address "::1", port 5432
2023-05-30 17:05:51.494 JST [2066] LOG:  listening on IPv4 address "127.0.0.1", port 5432
2023-05-30 17:05:51.494 JST [2066] LOG:  listening on Unix socket "/var/run/postgresql/.s.PGSQL.5432"
2023-05-30 17:05:51.495 JST [2066] LOG:  listening on Unix socket "/tmp/.s.PGSQL.5432"
2023-05-30 17:05:51.497 JST [2066] LOG:  database system was shut down at 2023-05-30 17:02:07 JST

2023-05-30 17:05:51.497 JST [2066] LOG:  invalid primary checkpoint record
2023-05-30 17:05:51.497 JST [2066] PANIC:  could not locate a valid checkpoint record   <- WAL 日志出错，无法找到有效的检查点

2023-05-30 17:05:51.524 JST [2066] LOG:  startup process (PID 2068) was terminated by signal 6: Aborted
2023-05-30 17:05:51.524 JST [2066] LOG:  aborting startup due to startup process failure
2023-05-30 17:05:51.524 JST [2066] LOG:  database system is shut down

$ pg_resetwal -D data01                        <- 执行 WAL 重置命令
Write-ahead log reset                          <- 成功重置 WAL

$ pg_ctl -D data01 start
waiting for server to start....2023-05-30 17:07:40.869 JST [2099] LOG:  redirecting log output
2023-05-30 17:07:40.869 JST [2099] HINT:  Future log output will appear in directory "log".
server started                                  <- 服务器成功启动
```



[日本PostgreSQLユーザ会 PostgreSQL 14.5文書「pg_controldata」](https://www.postgresql.jp/document/14/html/app-pgcontroldata.html)

