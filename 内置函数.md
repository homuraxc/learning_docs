# 内置函数

## 1. 代表性函数

函数是指可通过SQL语句调用并执行的、已定义的处理过程。

在PostgreSQL中，主要预设了以下三类代表性函数：聚合函数、字符串函数、算术函数。



**聚合函数**

→ 对多个数值数据进行处理并返回结果的函数。

**字符串函数**

→ 对字符串进行处理并返回结果的函数。

**算术函数**

→ 对数值进行处理并返回结果的函数。



每类函数的详细说明如下：

**【聚合函数】**

| 函数           | 说明                                                         |
| -------------- | ------------------------------------------------------------ |
| count(列名｜*) | 返回指定列中非 NULL 值的数据条数。设为 * 时，返回所有满足条件的数据条数。 |
| sum(列名)      | 返回指定数值列的总和。忽略 NULL。                            |
| avg(列名)      | 返回指定数值列的平均值。忽略 NULL。                          |
| min(列名)      | 返回指定列的最小值。可用于数值、日期、时间、字符串类型的列。 |
| max(列名)      | 返回指定列的最大值。可用于数值、日期、时间、字符串类型的列。 |



**【执行示例】**

```sql
testdb=# SELECT * FROM sample;
-- 确认 sample 表内容
 id | name | age
----+------+-----
  1 | 佐藤 | 20
  2 | 鈴木 | 30
  3 | 渡辺 | 25
  4 | NULL | NULL
(4 rows)

testdb=# SELECT count(*) FROM sample;
-- 获取包含 NULL 在内的总行数
 count
-------
 4

testdb=# SELECT count(age) FROM sample;
-- 获取 age 列非 NULL 值数量
 count
-------
 3

testdb=# SELECT sum(age) FROM sample;
-- 获取 age 列总和
 sum
-----
 75

testdb=# SELECT avg(age) FROM sample;
-- 获取 age 列平均值
 avg
----------------------
 25.0000000000000000

testdb=# SELECT min(age) FROM sample;
-- 获取 age 最小值
 min
-----
 20

testdb=# SELECT max(age) FROM sample;
-- 获取 age 最大值
 max
-----
 30
```



**【字符串函数】**

| 函数                                     | 说明                     |
| ---------------------------------------- | ------------------------ |
| lower(字符串)                            | 转换为小写字母返回       |
| upper(字符串)                            | 转换为大写字母返回       |
| char_length(字符串)                      | 返回字符串的字符数       |
| octet_length(字符串)                     | 返回字符串的字节数       |
| trim([去除字符] FROM 字符串)             | 去除指定字符，默认为空格 |
| lpad(字符串, 长度, 补齐字符)             | 左侧填充至指定长度       |
| rpad(字符串, 长度, 补齐字符)             | 右侧填充至指定长度       |
| substring(字符串 FROM 开始位置 FOR 长度) | 提取指定位置的子字符串   |
| replace(字符串, 替换前, 替换后)          | 替换字符串中的子串       |



**【执行示例】**

```sql
SELECT lower('ABCde'); -- 转换为小写
→ abcde

SELECT upper('ABCde'); -- 转换为大写
→ ABCDE

SELECT char_length('アイウエオ'); -- 获取字符数
→ 5

SELECT octet_length('アイウエオ'); -- 获取字节数
→ 15

SELECT trim('ABCde', 'ABC'); -- 去除指定字符
→ de

SELECT lpad('ABCde', 7, 'A'); -- 左填充至7位
→ AAABCde

SELECT rpad('ABCde', 7, 'Z'); -- 右填充至7位
→ ABCdeZZ

SELECT substring('ABCde' FROM 3 FOR 2); -- 提取第3位起2个字符
→ Cd

SELECT replace('ABCde', 'C', 'Z'); -- 替换 C 为 Z
→ ABZde
```



**【算术函数】**

| 函数                | 说明                        |
| ------------------- | --------------------------- |
| abs(数值)           | 返回数值的绝对值            |
| div(数值1, 数值2)   | 取整除的商                  |
| mod(数值1, 数值2)   | 取余数                      |
| floor(数值)         | 向下取整                    |
| ceil(数值)          | 向上取整                    |
| round(数值)         | 四舍五入                    |
| trunc(数值, 小数位) | 截断至指定小数位（默认0位） |
| random()            | 返回 0~1 之间的随机数       |



**【执行示例】**

```sql
SELECT abs(-25); -- 绝对值
→ 25

SELECT div(32, 5); -- 整除
→ 6

SELECT mod(32, 5); -- 余数
→ 2

SELECT floor(4.83); -- 向下取整
→ 4

SELECT ceil(4.83); -- 向上取整
→ 5

SELECT round(4.83); -- 四舍五入
→ 5

SELECT trunc(4.83, 1); -- 截断至1位
→ 4.8

SELECT random(); -- 随机数（第1次）
→ 0.70476...

SELECT random(); -- 随机数（第2次）
→ 0.00795...
```



[日本PostgreSQLユーザ会 PostgreSQL 14.5文書「9.21. 集約関数」](https://www.postgresql.jp/document/14/html/functions-aggregate.html)

[日本PostgreSQLユーザ会 PostgreSQL 14.5文書「SELECT」：GROUP BY句](https://www.postgresql.jp/document/14/html/sql-select.html#SQL-GROUPBY)

[日本PostgreSQLユーザ会 PostgreSQL 14.5文書「9.3. 算術関数と演算子」：表9.5 算術関数](https://www.postgresql.jp/document/14/html/functions-math.html#FUNCTIONS-MATH-FUNC-TABLE)

[日本PostgreSQLユーザ会 PostgreSQL 14.5文書「9.3. 算術関数と演算子」：表9.6 乱数関数](https://www.postgresql.jp/document/14/html/functions-math.html#FUNCTIONS-MATH-RANDOM-TABLE)

[日本PostgreSQLユーザ会 PostgreSQL 14.5文書「9.4. 文字列関数と演算子」](https://www.postgresql.jp/document/14/html/functions-string.html)

[SAK 図書館「PostgreSQL 編13 - 文字関数、連結、空白削除、置換、切出、検索、長さ、数値」](http://sak.cool.coocan.jp/w_sak3/doc/sysbrd/psql_k13.htm)

[SAK 図書館「PostgreSQL 編11 - 問い合わせ、集計、平均、最大、最小、重複、集合、複合」](http://sak.cool.coocan.jp/w_sak3/doc/sysbrd/psql_k11.htm)



---

## 2. 日期・时间函数

PostgreSQL 提供了用于获取或处理日期与时间的函数，这些函数称为日期・时间函数。

主要的日期・时间函数如下所示：



**【获取当前日期・时间的函数】**



**【处理日期・时间的函数】**

处理日期・时间的主要函数如下：



-   age(时间戳值1, 时间戳值2)

    返回两个时间戳值之间的差值。可使用 TIMESTAMP 类型。

-   age(日期1, 日期2)

    返回两个日期之间的差值。可使用 DATE 类型。

-   age(时间戳值)

    返回当前时间与指定时间戳之间的差值。可使用 TIMESTAMP 类型。

-   age(日期)

    返回当前日期与指定日期之间的差值。可使用 DATE 类型。

-   extract(字段 from 时间戳值)

    从时间戳值中仅提取指定字段的值并返回。

-   extract(字段 from interval 值)

    从 interval 值中仅提取指定字段的值并返回。

-   date_part('字段', 时间戳值)

    从时间戳值中仅提取指定字段的值并返回。

-   date_part('字段', interval 值)

    从 interval 值中仅提取指定字段的值并返回。



**【数据类型转换】**

在 PostgreSQL 中，可以通过以下方式将字符串转换为目标数据类型（CAST）：

```
'字符串'::数据类型
-- 或
数据类型 '字符串'
```

例如，若希望将表示日期时间的字符串视为 timestamp 类型，可以这样写：

```
'2024-05-01 12:00:00'::timestamp
-- 或
timestamp '2024-05-01 12:00:00'
```

以下执行示例中，将表示日期与时间的字符串转换为 timestamp 类型或 interval 类型，并用于日期・时间处理函数中。



**[执行示例]**





**【主要字段说明】**

| 字段名称     | 说明                                                         |
| ------------ | ------------------------------------------------------------ |
| year         | 表示年份的字段                                               |
| month        | 表示月份的字段（timestamp 为 1~12，interval 为月数对 12 取余） |
| day          | 表示天数的字段（timestamp 为 1~31，interval 表示天数）       |
| hour         | 表示小时的字段（0~23）                                       |
| minute       | 表示分钟的字段（0~59）                                       |
| second       | 表示秒的字段（0~59）                                         |
| milliseconds | 表示秒数 × 1000 的字段                                       |
| microseconds | 表示秒数 × 1,000,000 的字段                                  |

