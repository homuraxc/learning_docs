# 五、配置文件



PostgreSQL安装后可以立即启动并使用，但在实际业务中，需要将参数的默认值设置为适合用途的值。

配置文件在执行 initdb 时创建，并放置在数据库集群中。



## postgresql.conf



在 PostgreSQL 的配置文件中，用于控制整个 PostgreSQL 行为的配置文件是「postgresql.conf」。



其格式如下。参数名后的等号（=）可以省略。

```
参数名 = 设置值
```

【设置方法】

-   每行设置一个参数
-   不区分大小写
-   从 # 到行末是注释（# 可以出现在任何位置）
-   参数值的类型为：布尔型、整数型、浮点型、字符串
-   布尔值可以是 on、off、true、false、yes、no、1、0（也可使用 t 或 f 等简写）
-   可根据参数的数据类型设置单位
    -   内存单位：B（字节）、kB（千字节）、MB（兆字节）、GB（吉字节）、TB（太字节）（倍率为1024，k需小写）
    -   时间单位：us（微秒）、ms（毫秒）、s（秒）、min（分钟）、h（小时）、d（天）



可设置的项目种类繁多。

要更改参数，需要用文本编辑器打开并修改「postgresql.conf」文件。

除了直接修改文件外，也可以通过超级用户或普通用户的 SET 命令来更改某些参数。

通过 SET 命令设置的值仅在执行命令的会话（即与 PostgreSQL 服务器的连接）中有效。

参数变更的生效时机取决于参数的类型，可能是「PostgreSQL 的启动或重启（pg_ctl restart）」「重新加载配置文件（pg_ctl reload）」「由超级用户执行 SET 命令」「由普通用户执行 SET 命令」。

如果在后面描述的时机可以生效，那么前面描述的时机也可以生效。



建议为各参数设置适当的值。

特别是日志相关参数，默认情况下不会输出日志，因此建议在运维时将其更改为可用。



### 【postgresql.conf 文件的主要参数与生效时机】

| 分类       | 参数名                        | 参数说明                                 | 默认值                         | 启动(重启) | 重新加载 | SET命令（超级用户） | SET命令（普通用户） |
| ---------- | ----------------------------- | ---------------------------------------- | ------------------------------ | ---------- | -------- | ------------------- | ------------------- |
| 连接       | listen_addresses              | 接收连接请求的PostgreSQL服务器自身IP地址 | localhost                      | ○          | -        | -                   | -                   |
|            | port                          | 等待连接的端口号                         | 5432                           | ○          | -        | -                   | -                   |
|            | max_connections               | PostgreSQL可同时连接的最大连接数         | 100                            | ○          | -        | -                   | -                   |
| 客户端连接 | search_path                   | 用于搜索省略了schema名的表的路径         | '"$user", public'              | ○          | ○        | ○                   | ○                   |
|            | default_transaction_isolation | 新事务的默认隔离级别                     | read committed                 | ○          | ○        | ○                   | ○                   |
|            | client_encoding               | 客户端的编码方式                         | 'SQL_ASCII'                    | ○          | ○        | ○                   | ○                   |
| 日志       | logging_collector             | 是否将标准错误输出写入文件               | off                            | ○          | -        | -                   | -                   |
| 记录在哪   | log_destination               | PostgreSQL日志输出的目标位置             | stderr                         | ○          | ○        | -                   | -                   |
| 记录在哪   | log_directory                 | 存放日志文件的目录                       | log                            | ○          | ○        | -                   | -                   |
| 记录在哪   | log_filename                  | 服务器日志的文件名                       | postgresql-%Y-%m-%d_%H%M%S.log | ○          | ○        | -                   | -                   |
| 记录在哪   | log_line_prefix               | 服务器日志每行开头的格式字符串           | '%m [%p] '                     | ○          | ○        | -                   | -                   |
| 记录什么   | log_connections               | 是否将客户端信息输出到服务器日志中       | off                            | ○          | ○        | ○                   | -                   |
| 记录什么   | log_min_messages              | 写入服务器日志的日志等级                 | WARNING                        | ○          | ○        | ○                   | -                   |
| 记录什么   | log_statement                 | 要写入服务器日志的SQL语句的种类          | none                           | ○          | ○        | ○                   | -                   |

注：
- ○ 表示支持该方式进行设置
- “-” 表示该方式不可用



### 【各参数的详细说明】

-   **listen_addresses**

    指定 PostgreSQL 服务器接受客户端连接请求的自身 IP 地址（**指定 PostgreSQL 去监听哪些服务器上的网卡**）。

    在初始化数据库集群后仍可更改。更改后需要重启 PostgreSQL 服务器才能生效。

    默认值 localhost 表示回环地址，即服务器自身。

    该地址常用于由在同一台服务器上运行的其他软件访问其提供的功能。

    因此，默认值仅允许 PostgreSQL 服务器自身（包括运行在其上的其他软件）连接，不允许远程连接。

    若指定为 ‘*’，则会监听所有 IP 地址的连接请求。



-   **port**

    设置监听连接请求的端口号。更改后需重启 PostgreSQL 服务器才能生效。默认值为 5432。



-   **max_connections**

    设置 PostgreSQL 允许的同时连接的最大数量。更改后需重启 PostgreSQL 服务器才能生效。默认值为 100。该参数为整数型。

    若连接数超过此值，则会发生错误并拒绝连接。



-   **search_path**

    设置用于搜索省略了 schema 名的表的路径。

    schema 是根据表的用途或所有者将多个数据库的存储位置分类的一种机制。

    关于 schema 的详细说明，请参考“基本的运用管理作业”与“SQL 命令”部分。

    更改后的设置值在 PostgreSQL 服务器重启或重新加载「postgresql.conf」文件后生效。

    若在执行命令的会话中，也可以使用 SET 命令更改该参数。默认值为 ‘”$user”, public’。



-   **default_transaction_isolation**

    设置新事务的默认隔离级别。隔离级别表示在其他事务同时执行时，当前事务受到多大影响的程度。

    可设定的隔离级别如下：

    -   read uncommitted
    -   read committed
    -   repeatable read
    -   serializable

    这些隔离级别将在“事务的概念”部分详细说明。

    更改后需重启 PostgreSQL 服务器或重新加载配置文件才能生效。也可以通过 SET 命令在会话中更改。

    默认值为 read committed。



-   **client_encoding**

    设置客户端编码。更改后需重启 PostgreSQL 服务器或重新加载配置文件才能生效。也可以在会话中使用 SET 命令更改。默认值为 ‘SQL_ASCII’。



-   **log_destination**

    设置 PostgreSQL 服务器的日志输出目标。更改后需重启或重新加载配置文件。

    可设定的日志输出目标如下：

    -   stderr：将服务器日志以纯文本形式输出到标准错误
    -   csvlog：以 CSV 格式输出到标准错误（需将 logging_collector 设为 on）
    -   syslog：输出日志到 syslog

    默认值为 stderr。



-   **logging_collector**

    设置是否将标准错误输出写入文件。更改后需重启 PostgreSQL 服务器才能生效。默认值为 off。



-   **log_directory**

    设置日志文件的保存目录。更改后需重启 PostgreSQL 服务器或重新加载配置文件才能生效。默认值为 log。



-   **log_connections**

    设置是否将客户端信息输出到服务器日志。若设为 on，将记录连接尝试和认证成功的信息。

    更改后需重启或重新加载配置文件才能生效。会话中可由超级用户使用 SET 命令更改。默认值为 off。



-   **log_min_messages**

    设置写入服务器日志的最低日志级别。更改后需重启或重新加载配置文件才能生效。会话中可由超级用户使用 SET 命令更改。默认值为 WARNING。

    每个级别包含其以下的所有级别。级别越低（高：INFO -> 低：PANIC），记录的消息越少。

    可设定的日志级别如下：

    -   INFO：用户请求输出的信息

    -   NOTICE：对用户有帮助的信息

    -   WARNING：对不当命令使用的警告

    -   ERROR：中断特定命令的错误

    -   LOG：对数据库管理员有用的性能与内部处理信息

    -   FATAL：中断特定会话的错误

    -   PANIC：中断所有会话的致命错误



-   **log_filename**

    设置服务器日志的文件名。更改后需重启 PostgreSQL 服务器或重新加载配置文件才能生效。



-   **log_line_prefix**

    设置服务器日志每行开头的格式字符串，包括用户名、数据库名、日期等信息。

    默认值为 ’%m [%p] ’，其中 %m 表示带毫秒的日期时间，%p 表示进程 ID。更改后需重启或重新加载配置文件才能生效。



-   **log_statement**

    设置写入服务器日志的 SQL 语句类型。更改后需重启或重新加载配置文件才能生效。会话中可由超级用户使用 SET 命令更改。默认值为 none。

    可设定的值如下：

    -   none（off）：不记录

    -   ddl：只记录 CREATE、ALTER、DROP 等 DDL

    -   mod：记录 DDL 以及 INSERT、UPDATE、DELETE、TRUNCATE、COPY FROM 等修改数据的语句

    -   all：记录所有 SQL（但语法错误的语句不会记录）



### ALTER SYSTEM



这是 PostgreSQL 9.4 版本新增功能的 SQL 命令，用于更改服务器参数值。

其效果与直接修改 postgresql.conf 文件相同。

该命令只能由超级用户执行。

与 SET 命令不同，**它不受可更改参数的限制，也不局限于当前会话**。

实际操作中，ALTER SYSTEM 设置的值会写入 postgresql.auto.conf 文件，并在读取 postgresql.conf 时覆盖掉postgresql.conf文件中的该参数。

但是postgresql.conf文件中这个参数值不会被修改，只是对于PostgreSQL服务，postgresql.auto.conf文件中的该参数具有更高的优先级。

-   postgresql.conf 最先被加载
-   然后 postgresql.auto.conf 被加载
-   **后加载的 postgresql.auto.conf 中的值会覆盖前面的 postgresql.conf 中的同名参数**



其语法如下：

```
ALTER SYSTEM SET 参数名 TO {设置值 | DEFAULT};
ALTER SYSTEM SET 参数名 = {设置值 | DEFAULT};
```



【执行示例】

```sql
postgres=# SHOW log_min_messages;        ←确认当前的设定值
 log_min_messages
------------------
 warning
(1 行)

postgres=# ALTER SYSTEM SET log_min_messages TO 'INFO';
ALTER SYSTEM                             ←ALTER SYSTEM 命令被正常执行
postgres=# SHOW log_min_messages;
 log_min_messages
------------------
 warning                                 ←因为「postgresql.conf」的值未被覆盖，SHOW命令的结果相同
(1 行)
```



通过 ALTER SYSTEM 命令设置的值会自动写入到 postgresql.auto.conf 文件中。

【postgresql.auto.conf 文件内容】

```
# Do not edit this file manually!
# It will be overwritten by ALTER SYSTEM command.
log_min_messages = 'INFO'
```



### pg_settings



这是获取服务器参数值的视图。

name 列显示参数名，setting 列显示参数值。

可以通过 UPDATE 语句更新，等同于执行 SET 命令更改参数值。

但无法执行插入或删除操作。



此外，通过 context 列可以读取参数变更所需的操作。

主要取值如下：



-   internal：数据库集群构建后不可更改
-   postmaster：需重启 PostgreSQL 服务器
-   sighup：需重新加载 postgresql.conf
-   superuser-backend：需以超级用户开启新会话
-   backend：需以普通用户开启新会话
-   superuser：由超级用户执行 SET 命令
-   user：由普通用户执行 SET 命令





【执行示例】

```sql
postgres=# SELECT * FROM pg_settings WHERE name = 'client_min_messages';
-[ RECORD 1 ]-----------------------------------------
name        | client_min_messages
setting     | notice
unit        | 
category    | Reporting and Logging / When to Log
short_desc  | Sets the message levels that are sent to the client.
extra_desc  | Each level includes all the levels that follow it. The later the level, the fewer messages are sent.
context     | user
vartype     | enum
source      | default
min_val     | 
max_val     | 
enumvals    | {debug5,debug4,debug3,debug2,debug1,log,notice,warning,error}
boot_val    | notice
reset_val   | notice
sourcefile  | 
sourceline  | 
pending_restart | f

postgres=# UPDATE pg_settings SET setting = 'error' WHERE name = 'client_min_messages';  ← 变更参数
-[ RECORD 1 ]-----
set_config  | error
UPDATE 0

postgres=# SELECT * FROM pg_settings WHERE name = 'client_min_messages';
-[ RECORD 1 ]-----------------------------------------
name        | client_min_messages
setting     | error
unit        | 
category    | Reporting and Logging / When to Log
short_desc  | Sets the message levels that are sent to the client.
extra_desc  | Each level includes all the levels that follow it. The later the level, the fewer messages are sent.
context     | user
vartype     | enum
source      | session
min_val     | 
max_val     | 
enumvals    | {debug5,debug4,debug3,debug2,debug1,log,notice,warning,error}
boot_val    | notice
reset_val   | notice
sourcefile  | 
sourceline  | 
pending_restart | f
```



[日本PostgreSQLユーザ会 PostgreSQL 14.5文書「20.8. エラー報告とログ取得」：log_filename](https://www.postgresql.jp/document/14/html/runtime-config-logging.html#GUC-LOG-FILENAME)

[日本PostgreSQLユーザ会 PostgreSQL 14.5文書「20.8. エラー報告とログ取得」：logging_collector](https://www.postgresql.jp/document/14/html/runtime-config-logging.html#GUC-LOGGING-COLLECTOR)



## 2. pg_hba.conf

在 PostgreSQL 的配置文件中，用于控制来自客户端连接的配置文件是 pg_hba.conf。



客户端认证由数据库集群内的名为 pg_hba.conf 的配置文件进行管理。hba 是 host-based authentication（基于主机的认证）的缩写。

对 pg_hba.conf 文件所做的更改，将通过重新加载文件（pg_ctl reload）来生效。



格式如下：

```
local 数据库名 用户名 认证方式  
host 数据库名 用户名 IP地址 子网掩码 认证方式  
host 数据库名 用户名 CIDR地址 认证方式  
```



### (1) 设置方法

-   客户端的设置每行只能写一个，不能跨多行。
-   每一行的记录由空格或制表符（Tab）分隔的多个字段组成。
-   当字段的值包含空格时，用 "（双引号）括起来。
-   从 # 开始直到行尾表示注释（# 可以出现在任何位置）。



pg_hba.conf 文件的常规格式是「每行一个记录」的记录集合。

当接收到来自客户端的连接时，会根据连接方式、客户端的 IP 地址、目标数据库名、使用的用户名等，去匹配 pg_hba.conf 文件中是否存在对应的记录。



客户端认证的判断是从文件上方的记录开始逐行进行，只要匹配成功，就使用该行指定的方式进行认证。

如果认证成功，则允许连接；如果认证失败，则拒绝连接。

一旦认证成功或失败，**不会继续检查后续的记录**。



如果没有找到匹配的记录，则该连接请求将被拒绝。



### (2) pg_hba.conf 文件的主要认证方式

| 认证方式 | 说明                         |
| -------- | ---------------------------- |
| trust    | 始终允许                     |
| reject   | 始终拒绝                     |
| md5      | 使用 MD5 加密的密码进行认证  |
| password | 使用未加密的明文密码进行认证 |



### (3) pg_hba.conf 文件的各字段说明

-   **连接方式**

    指定客户端认证所使用的连接方式。

    -   host：对应 TCP/IP 连接
    -   local：对应 UNIX 域连接

-   **数据库名**

    指定要连接的数据库名称。可以用逗号分隔多个数据库。

    all 表示所有数据库。

-   **用户名**

    指定用于连接的数据库用户名。可以用逗号分隔多个用户。

    all 表示所有用户。

-   **IP地址 和 子网掩码**

    适用于连接方式为 host 的情况。用于限定客户端的 IP 地址范围。

    示例：
    192.168.1.0 255.255.255.0 → 匹配的 IP 地址为 192.168.1.1 到 192.168.1.254
    子网掩码 255.255.255.0 转换成二进制为：11111111.11111111.11111111.00000000
    表示从头数起24位（即1的部分）相同的 IP 地址会被匹配。
    ※ 192.168.1.0 为网络地址，192.168.1.255 为广播地址，不能作为客户端 IP 使用。

-   **CIDR地址**

    适用于连接方式为 host 的情况。也用于限定客户端 IP 范围。

    是将 IP 地址和掩码长度用斜杠隔开的一种表示法。作为子网掩码的替代方式使用。

    示例：
    192.168.1.0/24 → 匹配的 IP 地址为 192.168.1.1 到 192.168.1.254



### (4) 客户端认证的设置示例

- 允许所有来自 UNIX 域的连接  
- 当从 IP 地址 192.168.1.1 到 192.168.1.254 的主机连接数据库 example 且用户名为 test 时，使用明文密码认证  
- 拒绝来自 IP 地址 192.168.16.1 到 192.168.16.254 的所有连接
local all all trust  
host example test 192.168.1.0/24 password  
host all all 192.168.16.0/24 reject  



[日本PostgreSQLユーザ会 PostgreSQL 14.5文書「21.1. pg_hba.confファイル」](https://www.postgresql.jp/document/14/html/auth-pg-hba-conf.html)

[日本PostgreSQLユーザ会 PostgreSQL 14.5文書「20.1. パラメータの設定」](https://www.postgresql.jp/document/14/html/config-setting.html)





